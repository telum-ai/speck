# Speck Retrospective
#
# Triggers after a Speck story PR is approved and merged.
# Creates an issue for Copilot to run story-retrospective.

name: Speck Retrospective

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - develop

permissions:
  contents: read
  issues: write

jobs:
  trigger-retrospective:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.merged == true &&
      (contains(github.event.pull_request.title, '[Speck]') || 
       startsWith(github.event.pull_request.head.ref, 'copilot/'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Create retrospective issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Extract story name and path from PR
          STORY_NAME=$(echo "$PR_TITLE" | sed 's/.*\[Speck\] //' | head -1)
          STORY_PATH=$(echo "$PR_BODY" | grep -oP '(?<=\*\*Path\*\*: `)[^`]+' | head -1 || true)
          
          if [ -z "$STORY_PATH" ]; then
            echo "Could not determine story path, skipping retrospective"
            exit 0
          fi
          
          # Create retrospective issue
          cat > /tmp/retro_body.md << EOF
          ## Story Retrospective: $STORY_NAME

          **Story Path**: \`$STORY_PATH\`
          **Merged PR**: #$PR_NUMBER

          @copilot Please run the retrospective for this story:

          1. Read \`AGENTS.md\` for the methodology
          2. Navigate to \`$STORY_PATH\`
          3. Execute \`.cursor/commands/story-retrospective.md\`:
             - Mine git commits for learning tags (PATTERN:, GOTCHA:, PERF:, etc.)
             - Read validation-report.md for spec accuracy
             - Create story-retro.md with structured learnings
             - Apply immediate learnings to future stories in this epic
          4. Commit the story-retro.md file

          This captures learnings that feed into the epic retrospective.
          EOF
          
          gh issue create \
            --title "ðŸ“ [Speck Retro] $STORY_NAME" \
            --body-file /tmp/retro_body.md \
            --label "speck:story,automated,speck:ready"
          
          echo "Created retrospective issue for: $STORY_NAME"
