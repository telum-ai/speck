# Speck Orchestrator
#
# Continuous orchestration of story work. Creates issues and assigns to Copilot.
# Drives stories through the ENTIRE Speck flow up to and including story-validate.
#
# SCOPE: All commands from story-specify through story-validate
# COMPLETION: Story is complete when validation-report.md exists with PASS status

name: Speck Orchestrator

on:
  # Continuous orchestration - check every 15 minutes
  schedule:
    - cron: '*/15 * * * *'
  
  # Trigger on spec changes
  push:
    paths:
      - 'specs/**/epic-breakdown.md'
      - 'specs/**/stories/**'
    branches:
      - main
      - develop
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      epic_path:
        description: 'Epic path (or leave empty to scan all)'
        required: false
        type: string
      specs_root:
        description: 'Specs root directory (default: specs)'
        required: false
        type: string
        default: 'specs'
      single_story:
        description: 'Only process this single story ID (for testing)'
        required: false
        type: string
        default: ''
      test_mode:
        description: 'Test mode - adds test:e2e label for cleanup'
        required: false
        type: boolean
        default: false
  
  # Re-orchestrate after PR merges (unblock dependents, continue validation)
  pull_request:
    types: [closed]
    branches:
      - main
      - develop

permissions:
  contents: read
  issues: write
  pull-requests: read

env:
  MAX_CONCURRENT_COPILOT: 3

jobs:
  ensure-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Create Speck labels if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh label create "speck:story" --color "0E8A16" --description "Speck story" --force --repo "$GH_REPO" || true
          gh label create "speck:blocked" --color "B60205" --description "Blocked by dependencies" --force --repo "$GH_REPO" || true
          gh label create "speck:queued" --color "C5DEF5" --description "Queued for Copilot" --force --repo "$GH_REPO" || true
          gh label create "speck:in-progress" --color "FBCA04" --description "Copilot working" --force --repo "$GH_REPO" || true
          gh label create "speck:validated" --color "0E8A16" --description "Story validated" --force --repo "$GH_REPO" || true
          gh label create "automated" --color "BFD4F2" --description "Created by automation" --force --repo "$GH_REPO" || true

  orchestrate:
    needs: ensure-labels
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run orchestrator
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EPIC_PATH: ${{ inputs.epic_path || '' }}
          REPO: ${{ github.repository }}
          SPECS_ROOT: ${{ inputs.specs_root || 'specs' }}
          SINGLE_STORY: ${{ inputs.single_story || '' }}
          DRY_RUN: "false"
          TEST_MODE: ${{ inputs.test_mode && 'true' || 'false' }}
        run: |
          chmod +x .speck/scripts/orchestrate.sh
          .speck/scripts/orchestrate.sh

  unblock-dependents:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Unblock dependent stories
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          REPO: ${{ github.repository }}
        run: |
          STORY_NAME=$(echo "$PR_TITLE" | grep -oE 'S[0-9]{3}[^ ]*' | head -1 || echo "")
          [ -z "$STORY_NAME" ] && exit 0
          
          echo "Story merged: $STORY_NAME"
          
          # Check if the merged story now has a passing validation
          STORY_DIR=$(find specs -type d -name "*$STORY_NAME*" 2>/dev/null | head -1)
          if [ -z "$STORY_DIR" ] || [ ! -f "$STORY_DIR/validation-report.md" ]; then
            echo "Story not yet validated, dependents remain blocked"
            exit 0
          fi
          
          if ! grep -q "Status.*PASS" "$STORY_DIR/validation-report.md" 2>/dev/null; then
            echo "Story validation not PASS, dependents remain blocked"
            exit 0
          fi
          
          echo "Story validated with PASS, unblocking dependents"
          
          BLOCKED_ISSUES=$(gh issue list --repo "$REPO" --label "speck:blocked" --json number,body --jq '.[] | @base64' 2>/dev/null || true)
          
          for ISSUE_B64 in $BLOCKED_ISSUES; do
            ISSUE=$(echo "$ISSUE_B64" | base64 -d)
            ISSUE_NUM=$(echo "$ISSUE" | jq -r '.number')
            ISSUE_BODY=$(echo "$ISSUE" | jq -r '.body')
            
            if echo "$ISSUE_BODY" | grep -q "$STORY_NAME"; then
              echo "Unblocking issue #$ISSUE_NUM"
              gh issue edit "$ISSUE_NUM" --repo "$REPO" --remove-label "speck:blocked" --add-label "speck:queued"
              gh issue comment "$ISSUE_NUM" --repo "$REPO" --body "âœ… Dependency **$STORY_NAME** validated! This story is now queued."
            fi
          done

  assign-copilot:
    needs: [ensure-labels, orchestrate]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Assign queued stories (rate limited)
        env:
          GH_TOKEN: ${{ secrets.COPILOT_ASSIGNMENT_TOKEN || secrets.GITHUB_TOKEN }}
          MAX_CONCURRENT: ${{ env.MAX_CONCURRENT_COPILOT }}
          REPO: ${{ github.repository }}
        run: |
          if [ -z "${{ secrets.COPILOT_ASSIGNMENT_TOKEN }}" ]; then
            echo "âš ï¸  WARNING: COPILOT_ASSIGNMENT_TOKEN not set!"
            echo "The default GITHUB_TOKEN cannot assign copilot-swe-agent[bot]."
            echo "Please create a PAT with 'repo' scope and add it as COPILOT_ASSIGNMENT_TOKEN secret."
            echo "See: .speck/README.md â†’ Autonomous Development â†’ Setup"
            exit 1
          fi
          
          IN_PROGRESS=$(gh issue list --repo "$REPO" --label "speck:in-progress" --json number --jq 'length' 2>/dev/null || echo "0")
          echo "In progress: $IN_PROGRESS / $MAX_CONCURRENT"
          
          AVAILABLE=$((MAX_CONCURRENT - IN_PROGRESS))
          [ "$AVAILABLE" -le 0 ] && { echo "Rate limit reached"; exit 0; }
          
          QUEUED=$(gh issue list --repo "$REPO" --label "speck:queued" --json number,labels --jq 'sort_by(.number) | .[] | @base64' | head -n "$AVAILABLE")
          
          for ISSUE_B64 in $QUEUED; do
            ISSUE_DATA=$(echo "$ISSUE_B64" | base64 -d)
            ISSUE_NUM=$(echo "$ISSUE_DATA" | jq -r '.number')
            IS_E2E_TEST=$(echo "$ISSUE_DATA" | jq -r '.labels | map(.name) | any(. == "test:e2e")')
            
            echo "Assigning Copilot to #$ISSUE_NUM (e2e_test=$IS_E2E_TEST)"
            
            # Build custom instructions based on whether this is an E2E test
            CUSTOM_INSTRUCTIONS=""
            if [ "$IS_E2E_TEST" = "true" ]; then
              CUSTOM_INSTRUCTIONS="ðŸ§ª E2E TEST MODE - This is an automated integration test. CRITICAL RULES: 1) Do NOT modify files in tests/fixtures/ - these are test data that must remain stable. 2) When you complete your work, commit a file named .e2e-test-complete with contents 'issue:$ISSUE_NUM' to trigger cleanup. 3) Keep your work minimal - just verify the story flow works. 4) The goal is to test the Speck orchestrator, not to do real implementation work."
            fi
            
            PAYLOAD=$(cat <<EOFPAYLOAD
          {
            "assignees": ["copilot-swe-agent[bot]"],
            "agent_assignment": {
              "target_repo": "$REPO",
              "base_branch": "main",
              "custom_instructions": "$CUSTOM_INSTRUCTIONS",
              "custom_agent": "",
              "model": ""
            }
          }
          EOFPAYLOAD
          )
            
            echo "$PAYLOAD" | gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/$REPO/issues/$ISSUE_NUM/assignees" \
              --input -
            
            gh issue edit "$ISSUE_NUM" --repo "$REPO" --remove-label "speck:queued" --add-label "speck:in-progress"
            
            echo "  âœ“ Copilot assigned to #$ISSUE_NUM"
          done

  mark-validated:
    needs: [ensure-labels, orchestrate]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Mark validated stories complete
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Find all in-progress issues and check if they're now validated
          IN_PROGRESS=$(gh issue list --repo "$REPO" --label "speck:in-progress" --json number,title --jq '.[] | @base64' 2>/dev/null || true)
          
          for ISSUE_B64 in $IN_PROGRESS; do
            ISSUE=$(echo "$ISSUE_B64" | base64 -d)
            ISSUE_NUM=$(echo "$ISSUE" | jq -r '.number')
            ISSUE_TITLE=$(echo "$ISSUE" | jq -r '.title')
            
            STORY_ID=$(echo "$ISSUE_TITLE" | grep -oE 'S[0-9]{3}[^ :]*' | head -1 || echo "")
            [ -z "$STORY_ID" ] && continue
            
            STORY_DIR=$(find specs -type d -name "*$STORY_ID*" 2>/dev/null | head -1)
            [ -z "$STORY_DIR" ] && continue
            
            if [ -f "$STORY_DIR/validation-report.md" ]; then
              if grep -q "Status.*PASS" "$STORY_DIR/validation-report.md" 2>/dev/null; then
                echo "Story $STORY_ID validated! Closing issue #$ISSUE_NUM"
                gh issue edit "$ISSUE_NUM" --repo "$REPO" --remove-label "speck:in-progress" --add-label "speck:validated"
                gh issue close "$ISSUE_NUM" --repo "$REPO" --reason completed --comment "âœ… Story validated successfully! See \`$STORY_DIR/validation-report.md\`"
              fi
            fi
          done
