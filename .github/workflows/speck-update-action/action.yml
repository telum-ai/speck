name: 'Speck Update'
description: 'Check for Speck updates and create a PR with changes'
branding:
  icon: 'refresh-cw'
  color: 'orange'

inputs:
  version:
    description: 'Target version (e.g., "v2.1.0" or "latest")'
    required: false
    default: 'latest'
  create-pr:
    description: 'Create a PR with the changes'
    required: false
    default: 'true'
  dry-run:
    description: 'Only show what would change'
    required: false
    default: 'false'
  github-token:
    description: 'GitHub token for creating PRs in YOUR repo'
    required: true
  speck-token:
    description: 'GitHub token with read access to telum-ai/speck (required if Speck repo is private)'
    required: false
    default: ''

outputs:
  current-version:
    description: 'Current Speck version'
    value: ${{ steps.check.outputs.current }}
  latest-version:
    description: 'Latest available version'
    value: ${{ steps.check.outputs.latest }}
  has-update:
    description: 'Whether an update is available'
    value: ${{ steps.check.outputs.has-update }}
  pr-url:
    description: 'URL of the created PR (if any)'
    value: ${{ steps.create-pr.outputs.pr-url }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Check for updates
      id: check
      shell: bash
      env:
        SPECK_TOKEN: ${{ inputs.speck-token }}
      run: |
        # Get current version from AGENTS.md or .speck/VERSION
        CURRENT=""
        if [ -f ".speck/VERSION" ]; then
          CURRENT=$(cat .speck/VERSION)
        elif [ -f "AGENTS.md" ]; then
          CURRENT=$(grep -oP '\*\*Speck Version\*\*:\s*\K[\d.]+' AGENTS.md | head -1)
          [ -n "$CURRENT" ] && CURRENT="v${CURRENT}.0"
        fi
        
        # Build auth header if speck-token provided (for private repos)
        AUTH_HEADER=""
        if [ -n "$SPECK_TOKEN" ]; then
          AUTH_HEADER="Authorization: token $SPECK_TOKEN"
        fi
        
        # Get latest version
        if [ -n "$AUTH_HEADER" ]; then
          LATEST=$(curl -s -H "$AUTH_HEADER" https://api.github.com/repos/telum-ai/speck/releases/latest | jq -r '.tag_name')
        else
          LATEST=$(curl -s https://api.github.com/repos/telum-ai/speck/releases/latest | jq -r '.tag_name')
        fi
        
        # Check for errors (private repo without token)
        if [ "$LATEST" == "null" ] || [ -z "$LATEST" ]; then
          echo "âŒ Could not fetch Speck releases. If the repo is private, provide speck-token."
          exit 1
        fi
        
        echo "current=$CURRENT" >> $GITHUB_OUTPUT
        echo "latest=$LATEST" >> $GITHUB_OUTPUT
        
        if [ "$CURRENT" != "$LATEST" ]; then
          echo "has-update=true" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Update available: $CURRENT â†’ $LATEST"
        else
          echo "has-update=false" >> $GITHUB_OUTPUT
          echo "âœ… Already up to date: $CURRENT"
        fi

    - name: Download and apply update
      if: steps.check.outputs.has-update == 'true' && inputs.dry-run != 'true'
      shell: bash
      env:
        TARGET_VERSION: ${{ inputs.version == 'latest' && steps.check.outputs.latest || inputs.version }}
        SPECK_TOKEN: ${{ inputs.speck-token }}
      run: |
        # Create temp directory for new version
        TEMP_DIR=$(mktemp -d)
        
        # Download release (with auth for private repos)
        if [ -n "$SPECK_TOKEN" ]; then
          curl -sL -H "Authorization: token $SPECK_TOKEN" \
            "https://api.github.com/repos/telum-ai/speck/tarball/${TARGET_VERSION}" | \
            tar -xz -C "$TEMP_DIR" --strip-components=1
        else
          curl -sL "https://github.com/telum-ai/speck/archive/refs/tags/${TARGET_VERSION}.tar.gz" | \
            tar -xz -C "$TEMP_DIR" --strip-components=1
        fi
        
        # Files to sync (methodology files only)
        SYNC_PATTERNS=(
          ".speck"
          ".cursor/commands"
          ".cursor/hooks"
          ".github/workflows/speck-orchestrator.yml"
          ".github/workflows/speck-validate-pr.yml"
          ".github/workflows/speck-retrospective.yml"
          ".github/copilot-instructions.md"
          ".github/instructions"
          ".github/ISSUE_TEMPLATE/speck-story.yml"
          "AGENTS.md"
        )
        
        # Sync files
        for pattern in "${SYNC_PATTERNS[@]}"; do
          if [ -e "$TEMP_DIR/$pattern" ]; then
            mkdir -p "$(dirname "$pattern")"
            cp -r "$TEMP_DIR/$pattern" "$pattern" 2>/dev/null || true
          fi
        done
        
        # Save version
        mkdir -p .speck
        echo "$TARGET_VERSION" > .speck/VERSION
        
        echo "âœ… Updated to $TARGET_VERSION"

    - name: Create PR
      id: create-pr
      if: steps.check.outputs.has-update == 'true' && inputs.create-pr == 'true' && inputs.dry-run != 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        SPECK_TOKEN: ${{ inputs.speck-token }}
        CURRENT_VERSION: ${{ steps.check.outputs.current }}
        TARGET_VERSION: ${{ inputs.version == 'latest' && steps.check.outputs.latest || inputs.version }}
      run: |
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Create branch
        BRANCH="chore/speck-update-${TARGET_VERSION}"
        git checkout -b "$BRANCH"
        
        # Commit changes
        git add -A
        git commit -m "chore: upgrade Speck to ${TARGET_VERSION}
        
        Updates Speck methodology from ${CURRENT_VERSION} to ${TARGET_VERSION}.
        
        See release notes: https://github.com/telum-ai/speck/releases/tag/${TARGET_VERSION}"
        
        # Push branch
        git push origin "$BRANCH"
        
        # Get release notes (with auth for private repos)
        if [ -n "$SPECK_TOKEN" ]; then
          RELEASE_BODY=$(curl -s -H "Authorization: token $SPECK_TOKEN" \
            "https://api.github.com/repos/telum-ai/speck/releases/tags/${TARGET_VERSION}" | \
            jq -r '.body // "See release notes for details."')
        else
          RELEASE_BODY=$(curl -s "https://api.github.com/repos/telum-ai/speck/releases/tags/${TARGET_VERSION}" | \
            jq -r '.body // "See release notes for details."')
        fi
        
        # Create PR
        PR_URL=$(gh pr create \
          --title "â¬†ï¸ Upgrade Speck to ${TARGET_VERSION}" \
          --body "## Speck Update

        This PR upgrades Speck from **${CURRENT_VERSION}** to **${TARGET_VERSION}**.

        ### What's Changed

        ${RELEASE_BODY}

        ### Release Notes

        https://github.com/telum-ai/speck/releases/tag/${TARGET_VERSION}

        ---
        *This PR was automatically created by the Speck Update Action.*" \
          --label "dependencies,speck")
        
        echo "pr-url=$PR_URL" >> $GITHUB_OUTPUT
        echo "âœ… Created PR: $PR_URL"
