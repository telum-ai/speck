name: Speck Template Feedback

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'specs/**/epic-retro.md'
      - 'specs/**/project-retro.md'

permissions:
  contents: read

jobs:
  export-feedback:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guard (requires SPECK_TEMPLATE_FEEDBACK_REPO + SPECK_TEMPLATE_FEEDBACK_TOKEN)
        run: |
          if [ -z "${{ secrets.SPECK_TEMPLATE_FEEDBACK_REPO }}" ]; then
            echo "ℹ️  SPECK_TEMPLATE_FEEDBACK_REPO not set. Skipping template feedback export."
            exit 0
          fi
          if [ -z "${{ secrets.SPECK_TEMPLATE_FEEDBACK_TOKEN }}" ]; then
            echo "ℹ️  SPECK_TEMPLATE_FEEDBACK_TOKEN not set. Skipping template feedback export."
            exit 0
          fi

      - name: Collect feedback blocks from changed retros
        id: collect
        shell: bash
        env:
          TEMPLATE_REPO: ${{ secrets.SPECK_TEMPLATE_FEEDBACK_REPO }}
          TEMPLATE_TOKEN: ${{ secrets.SPECK_TEMPLATE_FEEDBACK_TOKEN }}
        run: |
          set -euo pipefail

          # Determine candidate retro files.
          files=""
          if [ "${{ github.event_name }}" = "push" ]; then
            base_sha="${{ github.event.before }}"
            head_sha="${{ github.sha }}"
            if [ -z "$base_sha" ] || [ "$base_sha" = "0000000000000000000000000000000000000000" ]; then
              base_sha="$(git rev-parse HEAD~1 2>/dev/null || true)"
            fi
            if [ -n "$base_sha" ]; then
              files="$(git diff --name-only "$base_sha" "$head_sha" | grep -E '^specs/.*/(epic-retro|project-retro)\.md$' || true)"
            fi
          fi

          # For manual runs, scan all retros (safe default).
          if [ -z "$files" ]; then
            files="$(find specs -type f \( -name "epic-retro.md" -o -name "project-retro.md" \) 2>/dev/null || true)"
          fi

          if [ -z "$files" ]; then
            echo "No epic/project retro files found. Nothing to export."
            echo "has_feedback=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          body_file="$(mktemp)"
          has_feedback=false

          {
            echo "# Speck template feedback"
            echo ""
            echo "- Source repo: \`${{ github.repository }}\`"
            echo "- Source ref:  \`${{ github.sha }}\`"
            echo "- Workflow:    \`${{ github.workflow }}\`"
            echo ""
            echo "The sections below were extracted from `SPECK_FEEDBACK` blocks in epic/project retros."
            echo ""
          } > "$body_file"

          for f in $files; do
            [ -f "$f" ] || continue

            extracted="$(mktemp)"
            awk '
              /<!-- SPECK_FEEDBACK:START -->/ {flag=1; next}
              /<!-- SPECK_FEEDBACK:END -->/ {flag=0}
              flag {print}
            ' "$f" | sed '/^[[:space:]]*$/d' > "$extracted"

            if [ -s "$extracted" ]; then
              has_feedback=true
              echo "## $f" >> "$body_file"
              echo "" >> "$body_file"
              echo "```markdown" >> "$body_file"
              cat "$extracted" >> "$body_file"
              echo "```" >> "$body_file"
              echo "" >> "$body_file"
              echo "_Source link_: https://github.com/${{ github.repository }}/blob/${{ github.sha }}/$f" >> "$body_file"
              echo "" >> "$body_file"
            fi
          done

          if [ "$has_feedback" != "true" ]; then
            echo "No SPECK_FEEDBACK blocks found in changed retros."
            echo "has_feedback=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_feedback=true" >> "$GITHUB_OUTPUT"
          echo "body_path=$body_file" >> "$GITHUB_OUTPUT"

      - name: Create issue in template repo
        if: steps.collect.outputs.has_feedback == 'true'
        env:
          GH_TOKEN: ${{ secrets.SPECK_TEMPLATE_FEEDBACK_TOKEN }}
          TEMPLATE_REPO: ${{ secrets.SPECK_TEMPLATE_FEEDBACK_REPO }}
        run: |
          set -euo pipefail
          title="[Speck feedback] ${{ github.repository }} @ ${{ github.sha }}"
          gh issue create --repo "$TEMPLATE_REPO" --title "$title" --body-file "${{ steps.collect.outputs.body_path }}"

